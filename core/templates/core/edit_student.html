{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<div class="container mt-4">
  <div class="card shadow p-4">

    <h2 class="text-center mb-4">ðŸ“˜ Student Profile</h2>

    <!-- ================= BASIC DETAILS ================= -->
    <h4>Basic Details</h4>
    <table class="table table-bordered">
      <tr><th>Username</th><td>{{ student.user.username }}</td></tr>
      <tr><th>USN</th><td>{{ student.usn }}</td></tr>
      <tr><th>Branch</th><td>{{ student.branch }}</td></tr>
      <tr><th>Semester</th><td>{{ student.semester }}</td></tr>
      <tr><th>Section</th><td>{{ student.section }}</td></tr>
      <tr><th>Email</th><td>{{ student.email }}</td></tr>
      <tr><th>Phone</th><td>{{ student.phone }}</td></tr>
      <tr>
        <th>Proctor</th>
        <td>
          {% if student.proctor %}
            {{ student.proctor.username }}
          {% else %}
            <span class="text-danger">Not Assigned</span>
          {% endif %}
        </td>
      </tr>
    </table>

    <hr>

    <!-- ================= SEMESTER DROPDOWN ================= -->
    <form method="GET">
      <label><strong>Select Semester:</strong></label>
      <select name="sem" class="form-select w-auto d-inline-block" onchange="this.form.submit()">
        {% for s in semesters %}
          <option value="{{ s }}" {% if selected_sem = s %}selected{% endif %}>Semester {{ s }}</option>
        {% endfor %}
      </select>
    </form>

    <!-- ================= MARKS TABLE ================= -->
    <h3 class="mt-3">ðŸ“š Semester {{ selected_sem }} â€“ Marks & Attendance</h3>

    <table class="table table-bordered table-striped shadow-sm mt-3">
      <thead class="table-dark text-center">
        <tr>
          <th>Subject</th>
          <th>Code</th>
          <th>Internal 1</th>
          <th>Internal 2</th>
          <th>Total Internal</th>
          <th>External</th>
          <th>Total Marks</th>
          <th>Attendance %</th>
        </tr>
      </thead>

      <tbody>
        {% for m in marks %}
        <tr class="text-center">
          <td>{{ m.subject }}</td>
          <td>{{ m.subject_code }}</td>
          <td>{{ m.internal1 }}</td>
          <td>{{ m.internal2 }}</td>
          <td>{{ m.total_internal }}</td>
          <td>{{ m.external }}</td>
          <td>{{ m.total_marks }}</td>
          <td>{{ m.attendance_percentage }}%</td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="text-center py-3 text-muted">No records available.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- ================= PERFORMANCE GRAPH ================= -->
    <h4 class="mt-4">ðŸ“Š Performance Analysis (Semester {{ selected_sem }})</h4>
    <canvas id="studentPerformanceChart" height="120"></canvas>

    <!-- PASS JSON SAFELY TO JS -->
     <script>
    window.performanceData = JSON.parse('{{ performance_data_json|escapejs }}');
</script>
    <!-- LOAD CHART JS + OUR CHART FILE -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="{% static 'js/performance_chart.js' %}"></script>

    <!-- ================= BROADCASTS ================= -->
    <h5 class="mt-4">ðŸ“¢ HOD Broadcast Messages</h5>

    {% for b in broadcasts %}
      <div class="alert alert-info">
        <strong>{{ b.sender.username }}</strong><br>
        {{ b.content }}<br>
        <small class="text-muted">{{ b.timestamp }}</small>
      </div>
    {% empty %}
      <p class="text-muted">No messages.</p>
    {% endfor %}

    <!-- ================= BACK BUTTON ================= -->
    <div class="text-center mt-4">
      <a href="{% url 'proctor_dashboard' %}" class="btn btn-outline-dark">â¬… Back</a>
    </div>

  </div>
</div>

{% endblock %}
